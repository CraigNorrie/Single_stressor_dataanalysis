---
title: "Data analysis of laboratroy experiments on diploid and triploid pacific oysters"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

This is a notebook for the analysis of growth, mortality, and oxygen consumption data from the single stressor experiments examining the impact of pH, temperature, and DO levels on pacific oysters.

# Packages

```{r, results='hide'}
library(MASS)
library(tidyverse)
library(here)
library(survival)
library(ggfortify)
library(ggsurvfit)
library(survminer)
library(gridExtra)
library(frailtyEM)
library(lme4)
library(emmeans)
library(nlme)
library(report)
library(gridExtra)
```

# Temperature

## Growth

Read in and prepare the data
```{r}
sizedat_temp <- read.csv(here("Data", "Temperature", "Size_Temperature.csv"))
sizedat_temp <- sizedat_temp %>% 
  mutate(across(c("Treatment","Tank", "Ploidy", "Time", "Tag.colour", "Tag.num"), as.factor)) 

```

Plot the size distributions of each of the ploidy groups at the start and the end of the experiment
```{r, echo=FALSE}

sizedat_temp %>% ggplot(aes(x=Ploidy, y = Shell.Height, fill = Time))+geom_boxplot()+
    xlab("Ploidy")+ylab("Shell height (mm)")+theme_classic(base_size = 20)+
  scale_fill_manual(values = c("red", "blue")) +
    facet_wrap(~Treatment)
  
sizedat_temp %>% ggplot(aes(x=Ploidy, y = Mass, fill = Time))+geom_boxplot()+
  xlab("Ploidy")+ylab("Mass (g)")+theme_bw(base_size = 20)+
  scale_fill_manual(values = c("red", "blue"), breaks = unique(sizedat_temp$Time), labels = c("Start", "End")) +
  scale_x_discrete(labels = c("Diploids", "Induced Triploids", "Mated Triploids")) +
  facet_wrap(~Treatment)
```

Plot growth throughout the experiment


Conduct a linear mixed model to examine if there was a difference in the size of individuals at the start of the experiment and at the end. Will include each tank as a random factor. I will use the lme4 package for this.

Check the distribution of the data
```{r, echo=FALSE}
hist((sizedat_temp$Mass))
hist((sizedat_temp$Shell.Height))
```

and the distribution of log transformed data. Log transformed data is more normally distributed so I am going to do the analyses on log transformed data. 
```{r, echo=FALSE}
hist(log(sizedat_temp$Mass))
hist(log(sizedat_temp$Shell.Height))
```

Develop the model for size and print the contrasts and p values using emmeans package. First I am going to examine growth in terms of total oyster mass. Tank is included as a random effect to account for any inter tank variation. 
```{r}
massgrowthlme_temp <- sizedat_temp %>% 
  lme(log(Mass)~Ploidy*Time*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(massgrowthlme_temp)

emmeans_massgrowthlme_temp <- emmeans(massgrowthlme_temp, ~ Ploidy*Treatment*Time)
masscontrasts <- pairs(emmeans_massgrowthlme_temp)
masscontrastsdf <-  as.data.frame(masscontrasts)
sigpHmasscontrasts <- masscontrastsdf %>% filter(p.value <=0.05)
write.csv(sigpHmasscontrasts, "sigpHmasscontrasts")
heightgrowthlme_temp <- lmer(Shell.Height~Ploidy*Time*Treatment + (1|Tank), data = filter(sizedat_temp))

```

The second step is to examine growth in terms of shell height. 
```{r}
Shell.Heightgrowthlme_temp <- sizedat_temp %>% 
  lme(log(Shell.Height)~Ploidy*Time*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(Shell.Heightgrowthlme_temp)

emmeans_Shell.Heightgrowthlme_temp <- emmeans(Shell.Heightgrowthlme_temp, ~ Ploidy*Treatment*Time)
Shell.Heightcontrasts <- pairs(emmeans_Shell.Heightgrowthlme_temp)
Shell.Heightcontrastsdf <-  as.data.frame(Shell.Heightcontrasts)
sigpHShell.Heightcontrasts <- Shell.Heightcontrastsdf %>% filter(p.value <=0.05)
write.csv(sigpHShell.Heightcontrasts, "sigpHShell.Heightcontrasts")
heightgrowthlme_temp <- lmer(Shell.Height~Ploidy*Time*Treatment + (1|Tank), data = filter(sizedat_temp))

```

The results indicate that significant differences existed in the size of.....

## Mortality

Read in the mortality data and prepare it for analysis

```{r, results='hide', echo=FALSE}
temp_survivors <- read.csv(here("Data", "Temperature", "Temp__survivors.csv"))
temp_survivors$Tank <- as.factor(temp_survivors$Tank)
temp_tank_assignments <- read.csv(here("Data", "Temperature", "Temp_tank_assignments.csv"))
#Uncount each of the rows in the first survivor colum
individ_mortdat_temp <- temp_survivors %>%
  select(1:3) %>%
  uncount(weights = Surv_1)
individ_mortdat_temp$ID <- rep(1:30, length.out = nrow(individ_mortdat_temp))#Add an ID column so each individual has a unique ID

individ_mortdat_temp$status_Surv_0 <- 0

#Create a df to store all survival event data for analyes
survival_eventdat_temp <- individ_mortdat_temp

#create a for loop that gives all survivors a status across all
for (i in 3:31) {
  # Extract the current column name
  current_column_name <- colnames(temp_survivors)[i]
  
  # Remove "Survivors_" from the current column name
  stripped_column_name <- current_column_name
  
  # Create a new column name based on the stripped current column name
  new_column_name <- paste0("status_", stripped_column_name)
  
  # Uncount the specified column
  survivors_column <- temp_survivors[c(1:2, i)] %>%
    mutate(weights = as.numeric(get(current_column_name))) %>%
    uncount(weights)
  
  # Add an ID column from 1 to 15
  survivors_column <- survivors_column %>%
    group_by(across(c(1, 2))) %>%
    mutate(ID = row_number()) %>%
    ungroup()
  
  # Add a status column to indicate that these individuals are alive
  survivors_column[[new_column_name]] <- 0
  
  # Join the data frames
  survival_eventdat_temp <- left_join(survival_eventdat_temp, survivors_column, by = c("Tank", "Colour", "ID"))
}
 
#Select the columns that status at the begining
survival_eventdat_temp <- survival_eventdat_temp %>% select(-starts_with("Surv"))
#Now need to pivot longer for survival plots
survival_eventdat_temp <- survival_eventdat_temp %>% pivot_longer(cols= -c(1:3), names_to = "Time", values_to = "Status")
#Remove the status from the time column
survival_eventdat_temp <- survival_eventdat_temp %>% mutate(Time = gsub("status_Surv_", "", Time))
#Add 1 where there is a NA
survival_eventdat_temp$Status[is.na(survival_eventdat_temp$Status)] <- 1
#Only keep the first instance of 1 (An individual can only die once - Cue James Bond music).
survival_eventdat_temp <- survival_eventdat_temp %>%
  group_by(Tank, Colour, ID) %>%
  filter(row_number() <= which.max(Status == 1) | sum(Status == 1) == 0) %>% ungroup()
#Make sure that the sum of mortality events actually matches the number of mortalities. In the temperature experiment this was 20
survival_eventdat_temp$event <- survival_eventdat_temp$Status
survival_eventdat_temp$Time <- as.numeric(survival_eventdat_temp$Time)
sum(survival_eventdat_temp$Status)
#Merge the file with the list of treatment tanks
survival_eventdat_temp <- merge(survival_eventdat_temp, temp_tank_assignments, by = "Tank")

survival_eventdat_temp$Colour <- as.factor(survival_eventdat_temp$Colour)
```

### Plot the data
Now the the data is in the correct format I can ployt the mortality. Beacuse mortality was so low this will not be a very interesting plot. This shows pooled mortality across temperature treatments

```{r, echo=FALSE}
survival_eventdat_temp$Temp <- factor(survival_eventdat_temp$Temp, levels = c("7.5", "12.5", "17.5", "22.5", "27.5"))#Set the order for the facets
pooled_site_survplot_temp_pooled <- survival_eventdat_temp %>% 
  filter(Time <= 28) %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
            facet.by = "Temp",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = FALSE, 
            legend.labs = c("Induced Triploid","Diploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.7, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 20)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("#00688B", "#CD950C", "#8B0A50"))+
  scale_fill_manual(values = c("#00688B", "#CD950C", "#8B0A50"))

pooled_site_survplot_temp_pooled
#CReate a long plot to group with the others
longpooled_site_survplot_temp_pooled <- survival_eventdat_temp %>%
  filter(Time <= 28) %>%
  ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
                   facet.by = "Temp",
                   data = .,
                   risk.table = FALSE, pval = FALSE, conf.int = FALSE, 
                   legend.labs = c("Induced Triploid","Diploid", "Mated Triploid"),
                   xlab = "Time (days)",
                   ylim = c(0.7, 1),
                   legend.strata = FALSE, 
                   legend.title = "Ploidy",
                   ncol = 1) +  # Setting ncol to 1 to have one column of facets
  theme_bw(base_size = 20) +
  labs(legend = "ploidy") +
  scale_color_manual(values = c("#00688B", "#CD950C", "#8B0A50")) +
  scale_fill_manual(values = c("#00688B", "#CD950C", "#8B0A50"))

```

Plot the survival across tanks

```{r, echo=FALSE}
pooled_site_survplot_temp_Tank <- survival_eventdat_temp %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
            facet.by = "Tank",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            #legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.6, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 15)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("blue", "green", "red"))+
  scale_fill_manual(values = c("blue", "green", "red"))
pooled_site_survplot_temp_Tank
```

And finally the same plot, except faceted by Ploidy.

```{r, echo=FALSE}
pooled_site_survplot_temp_Ploidy <- survival_eventdat_temp %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Temp , data = .),
            facet.by = "Colour",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            #legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             #ylim = c(0.6, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 20)
  #labs(legend = "ploidy")+
  #scale_color_manual(values = c("blue", "green", "red"))+
  #scale_fill_manual(values = c("blue", "green", "red"))
pooled_site_survplot_temp_Ploidy
```

### Perform statistical analyses

Using the surv package in R I am going to analyse the data. First creating a Kaplan Meyer survival object and then examining the potential different models
```{r}
#Create a survival object for analyses
surv_temp <- with(survival_eventdat_temp, Surv(Time, event, type = "right"))#For some reason piping does not work here
#Create the survival models
K1_temp <- coxph(surv_temp ~ Temp , data = survival_eventdat_temp)
K2_temp <- coxph(surv_temp ~ Colour , data = survival_eventdat_temp)
K3_temp <- coxph(surv_temp ~ Colour + Temp, data = survival_eventdat_temp)
K4_temp <- coxph(surv_temp ~ Colour * Temp, data = survival_eventdat_temp)

summary(K1_temp)
summary(K2_temp)
summary(K3_temp)
summary(K4_temp)
```

The only model that did not converge was the model that examined survival differences between ploidies. The only significant impact that was shown here is the fact that mated triploids (red) had lower survival than the other two. This was really still an insignificant impact. 

Adding the random effect of tank here may show that this is a random tank effect, rather than a real effect. Thus, here I am going to perform a frailty analysis

```{r}
survival_eventdat_temp %>% emfrail(surv_temp ~ Temp*Colour + cluster(Tank),
            distribution = emfrail_dist(dist = "gamma"),
            data = .) %>%
  {.}

```


## Respiration
[Ding et al 2020](https://doi.org/10.3389/fmars.2020.00399) and [Bodenstein](https://www.frontiersin.org/articles/10.3389/fmars.2023.1194296/full) used ANOVAs to compare respiration rates.I will do a linear mixed model where I examine interactions between the environment, ploidy, and whether a heat shock or not has occured. I will include tank as a random factor to account for any potential between tank variation. 

### Read in the respiration data

```{r}
temp_resprates <- read.csv(here("Data", "Temperature", "temp_masscorrectedrates.csv")) %>% 
  select(Ploidy, Treatment, Tank, mass_corected_rate)
temp_resprates$mass_corected_rate <- temp_resprates$mass_corected_rate *-1#make the rates column positive
#Replace the negatives with zero
temp_resprates <- temp_resprates %>% mutate(mass_corected_rate = pmax(mass_corected_rate, 0))
temp_resprates <- temp_resprates %>% filter(Ploidy != "")
#Add a HS vs no HS column
temp_resprates$HS <- ifelse(grepl("HS", temp_resprates$Treatment), "HS", "NOHS")

temp_resprates <- temp_resprates %>% mutate_at(c("Treatment", "Tank", "Ploidy", "HS"), as.factor)
```

### Create plots for the data

Summarise the data 

```{r}
temprates_summary <- temp_resprates %>% group_by(Treatment, Ploidy, HS) %>% 
  summarise(temp_mean_resprate= mean(mass_corected_rate, na.rm = TRUE), sd_temp_resprate = sd(mass_corected_rate, na.rm = TRUE), n=n())
str(temprates_summary)
temprates_summary$SEM <- temprates_summary$sd_temp_resprate/(sqrt(temprates_summary$n))
#temprates_summary$sem_temp_resprate <- temprates_summary %>% unnest(cols = c("sem_temp_resprate"))
```

Plot the data in the form of a performance curve

```{r}
temprates_summary$Treatment <- gsub("HS", "", temprates_summary$Treatment)#Rmove the HS from the cells
temprates_summary$Treatment <- factor(temprates_summary$Treatment, levels = c("7.5", "12.5", "17.5", "22.5", "27.5"))#Set the order of the facets #Order the x axis
tempresprate_plot <- temprates_summary %>% #filter(HS == "NOHS") %>% 
  ggplot(aes(x=Treatment, y= temp_mean_resprate, group = Ploidy, colour = Ploidy))+geom_line()+
  xlab("Temperature (°C)")+ylab("Mean oxygen consumption (µmol h-1 g-1)")+
  geom_errorbar(aes(ymin=temp_mean_resprate-SEM, ymax = temp_mean_resprate+SEM, width = 0.2))+theme_bw(base_size = 20)+
  scale_color_manual(values = c("#CD950C", "#00688B", "#8B0A50"),   # Custom colors for each group
                     breaks = c("2m", "3m", "3c"),   # Names of your groups
                     labels = c("Diploids", "Mated Triploids", "Induced Triploids" ))+   # Custom labels for each group
  labs(color = "Ploidy")+  # Change the legend title to "Ploidy"
  facet_wrap(~HS, nrow = 2)
tempresprate_plot
```

### Statistical analysis of oxygen consumption

Inspect the data

```{r}
hist(temp_resprates$mass_corected_rate)
hist(sqrt((temp_resprates$mass_corected_rate+.001)))
```

The data looks best with a sqrt transformation. <Br>
I am going to do a linear mixed model with tank as a random factor. Tank as a random factor. but first check that there is need for a random factor. 
We compared the IAC using an ANOVA of the model that included a random tank effect and the model that did not have a random tank effect and found no differece, therefore we are not going to use a random tank effect in this analysis. This is for the non heat shocked individuals. 

```{r}
lm_temp_resp <- temp_resprates %>% filter(HS == "NOHS") %>% filter(mass_corected_rate != "NA") %>% 
  lme(sqrt(mass_corected_rate+.001)~Ploidy*Treatment, random = ~ 1|Tank, data=., method = "ML")
lm_temp_resp_no_randomeff <- temp_resprates %>% filter(HS == "NOHS") %>% filter(mass_corected_rate != "NA") %>% 
  lm(sqrt(mass_corected_rate+.001)~Ploidy*Treatment, data=.)
anova(lm_temp_resp, lm_temp_resp_no_randomeff)
#
# Calculate residuals
# Extract random effects using ranef
residuals <- resid(lm_temp_resp_no_randomeff)
# Plot residuals
par(mfrow = c(1, 2))  # Set up a 1x2 plotting grid
plot(residuals, main = "Residuals vs. Fitted", xlab = "Fitted values", ylab = "Residuals")
qqnorm(residuals, main = "Normal Q-Q Plot")
qqline(residuals)  # Add a line to the Q-Q plot
```

Residuals suggest that the data is normally distributed so I will stick with a sqrt transformation. Here I will do the pairwise comparison using. There are significant differences in all so I am going to do pairwise comparisons. 

```{r}
anova(lm_temp_resp_no_randomeff)

emmeans_lm_temp_resp <- emmeans(lm_temp_resp_no_randomeff, ~ Ploidy*Treatment)
temp_resp_contrasts_noHS <- pairs(emmeans_lm_temp_resp)
temp_resp_contrasts_noHS_df <-  as.data.frame(temp_resp_contrasts_noHS)
sig_temp_resp_contrasts_noHS_df <- temp_resp_contrasts_noHS_df %>% filter(p.value <=0.08)
sig_temp_resp_contrasts_noHS_df
#write.csv(sig_temp_resp_contrasts_noHS_df, "sigtemprespcontrasts_noHS.csv")
#heightgrowthlme_temp <- lmer(Shell.Height~Ploidy*Time*Treatment + (1|Tank), data = filter(sizedat_temp))

```

Repeat the above analyses for heat shocked individuals. Evaluate the models with fixed and no fixed effects. No differnce. Use the model with no fixed effects.
```{r}
lm_temp_resp_HS <- temp_resprates %>% filter(HS == "HS") %>% filter(mass_corected_rate != "NA") %>% 
  lme(sqrt(mass_corected_rate+.001)~Ploidy*Treatment, random = ~ 1|Tank, data=., method = "ML")
lm_temp_resp_no_randomeff_HS <- temp_resprates %>% filter(HS == "HS") %>% filter(mass_corected_rate != "NA") %>% 
  lm(sqrt(mass_corected_rate+.001)~Ploidy*Treatment, data=.)
anova(lm_temp_resp_HS, lm_temp_resp_no_randomeff_HS)
```

Do the analysis.
```{r}
anova(lm_temp_resp_no_randomeff_HS)
emmeans_lm_temp_resp_HS <- emmeans(lm_temp_resp_no_randomeff_HS, ~ Treatment)
temp_resp_contrasts_HS <- pairs(emmeans_lm_temp_resp_HS)
temp_resp_contrasts_HS_df <-  as.data.frame(temp_resp_contrasts_HS)
sig_temp_resp_contrasts_noHS_df <- temp_resp_contrasts_HS_df %>% filter(p.value <=0.08)
sig_temp_resp_contrasts_noHS_df
```


Calculate an oxygen consumption rate per gram per gram. This is to determine if smaller/larger individuals consume more oxygen per gram when they are smaller/larger. Similar to [McElhany et al. 2023](https://www.sciencedirect.com/science/article/pii/S0022098122000892?via%3Dihub)
# pH

## Growth

There was a lot of mortality across the tanks so this may be hard to work with. Regardless, I'll follow the same analysis techniques that I used for the temperature growth data. 

First read in and prepare the data
```{r}
pHsizedat <- read.csv(here("Data", "pH", "pH_sizedata.csv")) %>% 
  mutate_at(c("Tank", "Treatment", "Ploidy", "Time.point"), as.factor) %>% 
  filter(Ploidy != "Blank")

str(pHsizedat)
```

### Plot the growth data

```{r}
#Change the order of the facets
pHsizedat$Treatment <- factor(pHsizedat$Treatment, levels = c("CTRL", "250", "500", "750", "1000"))
pHsizedat %>% ggplot(aes(x=Ploidy, y = Mass, fill = Time.point))+geom_boxplot()+
  ylab("Mass (g)")+
  theme_bw(base_size = 20)+
  scale_fill_manual(values = c("red", "blue"), breaks = unique(sizedat_temp$Time), labels = c("Start", "End")) +
  scale_x_discrete(labels = c("Diploids", "Induced Triploids", "Mated Triploids")) +
  facet_wrap(~Treatment)

# pHsizedat %>% ggplot(aes(x=Ploidy, y = Height, fill = Time.point))+geom_boxplot()+
#   facet_wrap(~Treatment)
```

### Statistical analysis of growth data
Linear mixed model using tank as a random factor. Even though tank is unlikley to be of importance. 

Check the distribution of the data
```{r}
hist((pHsizedat$Mass))
hist((pHsizedat$Height))
#Log the data
hist(log(pHsizedat$Mass))#Mass should be logged but not height
```

Start with the mass model

```{r}
massgrowthlme_pH <- pHsizedat %>% 
  lme(log(Mass)~Ploidy*Time.point*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(massgrowthlme_pH)

emmeans_massgrowthlme_pH <- emmeans(massgrowthlme_pH, ~ Ploidy)
masscontrasts <- pairs(emmeans_massgrowthlme_pH)
masscontrasts
```

Ploidy was the only significant factor with regards to mass. Pairwise comparisons show that mated trips were heavier than the other two groups.

Now create a shell height model
```{r}
heightgrowthlme_pH <- pHsizedat %>% 
  lme((Height)~Ploidy*Time.point*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(heightgrowthlme_pH)
#Time point and ploidy are signifcant here, but there are no interactions
emmeans_heightgrowthlme_pH <- emmeans(heightgrowthlme_pH, ~ Ploidy+Time.point+Ploidy:Treatment)
heightcontrasts_pH <- pairs(emmeans_heightgrowthlme_pH)
heightcontrasts_pH
#output this data
heightcontrastsdf_pH <-  as.data.frame(heightcontrasts_pH)
sigheightcontrastsdf_pH <- heightcontrastsdf_pH %>% filter(p.value <=0.05)
write.csv(sigheightcontrastsdf_pH, "sigheightcontrasts_pH.csv")
```
No signifcant differences were observed between start and end sizes for any of the shell heights within ploidies and treatments. 

## Mortality

Read in the mortality data and prepare it for analysis. This involves changing the data from being only number of moralities at each sampling event to giving each individual a status. This is a lot of code to do not very much

```{r, echo=FALSE}
pH_mortdat <- read.csv(here("Data", "pH", "pH_mortality.csv"))
pH_mortdattemplate <- read.csv(here("Data", "pH", "Mortality_template.csv"))
pH_tanktrt <- read.csv(here("Data", "pH", "pH_Tank_assignments.csv"))
pH_mortdat$Tank <- as.factor(pH_mortdat$Tank)
pH_mortdattemplate$Tank <- as.factor(pH_mortdattemplate$Tank)
#merge the data with the tempalate
ph_mortdat_expanded <- left_join(pH_mortdattemplate, pH_mortdat, by = c("Tank", "Date", "Colour"))
#Replace the NAs with zeros
ph_mortdat_expanded <- ph_mortdat_expanded %>%
  mutate(Number_Morts = ifelse(is.na(Number_Morts), 0, Number_Morts))
#Now need to pivot wider to get the dates so we can subtract the dates
ph_mortdat_expanded <- ph_mortdat_expanded %>% pivot_wider(id_cols = c(Tank, Colour),
                                                           names_from='Date',
                                                           values_from='Number_Morts')
#Add a new collumn that has the total number per group at the start of the experiment (Think it was 15)
ph_mortdat_expanded$Survivors_Nov_2 <- 15-ph_mortdat_expanded$Nov_02

#calculate survivors at each time interval 
for (i in 4:10) {
  survivors <- ph_mortdat_expanded[, i+7] - ph_mortdat_expanded[, i]
  # Create new column name
  new_column_name <- paste0("Survivors_", colnames(ph_mortdat_expanded)[i])
  # Add new column with survivors
  ph_mortdat_expanded[, new_column_name] <- survivors
}

#now I need to create a df with 15 rows for each of the tanks and ploidys
ph_mortdat_expanded_repeated <- ph_mortdat_expanded %>%
  mutate(row_id = row_number()) %>%
  slice(rep(row_id, each = 15)) %>% 
  select(1,2)
#Now add in an id column where we repeat 1-15 for each tank
ph_mortdat_expanded_repeated$ID <- rep(1:15, length.out = nrow(ph_mortdat_expanded_repeated))
#add a status for the start of teh experiment, 0 indicates an indivvidual was alive 
ph_mortdat_expanded_repeated$status_Sep_30 <- 0

#Create a df to store all survival event data for analyes####################I FUCKED THIS UP SOMEHOW, GO BACK AND FIX IT#################!!!!!
for (i in 11:18) {
  # Extract the current column name
  current_column_name <- colnames(ph_mortdat_expanded)[i]
  
  # Remove "Survivors_" from the current column name
  stripped_column_name <- gsub("Survivors_", "", current_column_name)#Here I should remove "surv" from name
  
  # Create a new column name based on the stripped current column name
  new_column_name <- paste0("status_", stripped_column_name)
  
  # Uncount the specified column ###################THIS IS WHERE THINGS GO WRONG HERE###################
  survivors_column <- ph_mortdat_expanded[c(1:2, i)] %>%
    mutate(weights = as.numeric(get(current_column_name))) %>%
    uncount(weights)
  
  # Add an ID column from 1 to 15
  survivors_column <- survivors_column %>%
    group_by(across(c(1, 2))) %>%
    mutate(ID = row_number()) %>%
    ungroup()
  
  # Add a status column to indicate that these individuals are alive
  survivors_column[[new_column_name]] <- 0
  
  # Join the data frames
  ph_mortdat_expanded_repeated <- left_join(ph_mortdat_expanded_repeated, survivors_column, by = c("Tank", "Colour", "ID"))
}

#Now select only the coluimns that have the status
survival_eventdat_pH <- ph_mortdat_expanded_repeated %>% select(-starts_with("Surv"))
#Pivot longer 
survival_eventdat_pH <- survival_eventdat_pH %>% pivot_longer(cols= -c(1:3), names_to = "Time", values_to = "Status")
#Remove the added dates from the time columns
survival_eventdat_pH <- survival_eventdat_pH %>% mutate(Time = gsub("status_Nov_", "", Time))
survival_eventdat_pH <- survival_eventdat_pH %>% mutate(Time = gsub("status_Sep_30", "0", Time))
#Add 1 where there is a NA
survival_eventdat_pH$Status[is.na(survival_eventdat_pH$Status)] <- 1
#Only keep the first instance of 1 (An individual can only die once - Cue James Bond music).
survival_eventdat_pH <- survival_eventdat_pH %>%
  group_by(Tank, Colour, ID) %>%
  filter(row_number() <= which.max(Status == 1) | sum(Status == 1) == 0) %>% ungroup()
#Add an "event column
survival_eventdat_pH$event <- survival_eventdat_pH$Status
survival_eventdat_pH$Date <- as.numeric(survival_eventdat_pH$Time)
#Make sure that the sum of mortality events actually matches the number of mortalities. In the temperature experiment this was 250
sum(survival_eventdat_pH$Status)
#Join the CO2 data so we have a CO2 Level for each of our variables
survival_eventdat_pH <- merge(survival_eventdat_pH,pH_tanktrt, by = "Tank")

```

### Plot the data to visualise mortality between tanks

This plot shows pooled survival across pH treatments. This does not account for any random effects of tank that could influence survival. Just a starting point to get an overview of the data. 

```{r, echo=FALSE}
survival_eventdat_pH$CO2_level <- factor(survival_eventdat_pH$CO2_level, levels = c("0", "250", "500", "750", "1000"))#Set the order of the facets 
survival_eventdat_pH$Date1 <- survival_eventdat_pH$Date+3#The sampling events were off by 1 day
pooled_site_survplot_pH_pooled <- survival_eventdat_pH %>% 
 ggsurvplot_facet(survfit(Surv(Date1, event, type = "right") ~ Colour , data = .),
            facet.by = "CO2_level",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.7, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 20)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("#CD950C","#00688B", "#8B0A50"))+
  scale_fill_manual(values = c("#CD950C","#00688B", "#8B0A50"))
pooled_site_survplot_pH_pooled

#MAke it long to see all plots
pooled_site_survplot_pH_pooled <- factor(survival_eventdat_pH$CO2_level, levels = c("0", "250", "500", "750", "1000"))#Set the order of the facets 
survival_eventdat_pH$Date1 <- survival_eventdat_pH$Date+3#The sampling events were off by 1 day
longpooled_site_survplot_pH_pooled <- survival_eventdat_pH %>% 
 ggsurvplot_facet(survfit(Surv(Date1, event, type = "right") ~ Colour , data = .),
            facet.by = "CO2_level",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.7, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy",
            ncol=1)+
  theme_bw(base_size = 20)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("#CD950C","#00688B", "#8B0A50"))+
  scale_fill_manual(values = c("#CD950C","#00688B", "#8B0A50"))
longpooled_site_survplot_pH_pooled


```

Here I am going to see how different ploidies reacted to the same pH treatment. The same data as above (i.e. pooled) but faceted by ploidy rather than CO2

```{r, echo=FALSE}
pooled_site_survplot_pH_ploidy <- survival_eventdat_pH %>% 
 ggsurvplot_facet(survfit(Surv(Date, event, type = "right") ~ CO2_level , data = .),
            facet.by = "Colour",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE,
            ylim = c(0.6, 1),
            #legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
            legend.strata = FALSE,
            legend.title = "pCO2")+
  theme_bw(base_size = 15)
  #labs(legend = "ploidy")+
  #scale_color_manual(values = c("blue", "green", "red"))+
  #scale_fill_manual(values = c("blue", "green", "red"))
pooled_site_survplot_pH_ploidy
```


To see how survival varied across tanks this is a plot that shows the survival probability for each ploidy group across tanks.

```{r, echo=FALSE}
pooled_site_survplot_pH_tank <- survival_eventdat_pH %>% 
 ggsurvplot_facet(survfit(Surv(Date, event, type = "right") ~ Colour , data = .),
            facet.by = "Tank",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            #legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.6, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 15)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("blue", "green", "red"))+
  scale_fill_manual(values = c("blue", "green", "red"))
pooled_site_survplot_pH_tank
```

### Statistical analysis on the mortality data

First I am going to do a pooled analysis on all the data. This does not include a random effect of tank which I will include later. Using a cox proportional hazards model based on the analysis of McElhany. 

```{r, echo=FALSE}
#Create a survival object for analyses
surv_pH <- with(survival_eventdat_pH, Surv(Date, event, type = "right"))#For some reason piping does not work here
#Create the survival models
K1_pH <- coxph(surv_pH ~ CO2_level , data = survival_eventdat_pH)
K2_pH <- coxph(surv_pH ~ Colour , data = survival_eventdat_pH)
K3_pH <- coxph(surv_pH ~ Colour + CO2_level, data = survival_eventdat_pH)
K4_pH <- coxph(surv_pH ~ Colour * CO2_level, data = survival_eventdat_pH)

summary(K1_pH)
summary(K2_pH)
summary(K3_pH)
summary(K4_pH)
```

Results of these analyses show that there was as significant impact of pCO2 and ploidy on survival (when pooled). Significant interactions existed between ploidy and pCO2 levels. The graphs show that blue did not survive well in the highest pH treatement. 

I am going to add a random effect of tank here to assess inter tank variation. I am using the frailtyEM package (Balan and Putter 2019) as in McElhany crab survival analysis. I am going to include treatment and ploidy as fixed effects tank as a random effect. I have no idea if this is correct or how to interpret it. 

```{r}
survival_eventdat_pH1 <- survival_eventdat_pH %>% mutate(across(c("CO2_level","Tank", "Colour"), as.factor)) 
survival_eventdat_pH1$Time <- as.numeric(survival_eventdat_pH1$Time)
survival_eventdat_pH1$Time <- survival_eventdat_pH1$Time+1
pH_frailty_fit <- survival_eventdat_pH1 %>% emfrail(Surv(Time, event, type = "right") ~ CO2_level*Colour + cluster(Tank),
distribution = emfrail_dist(dist = "gamma"),
data = .)

```

## Respiration

Read in the data and prepare to analyse it

```{r}
pHresprates <- read.csv(here("Data", "pH", "pH_masscorrectedrates.csv")) %>% 
  select("Treatment", "Tank", "Colour", "standardised_rate", "HS", "pCO2") %>% 
  filter(standardised_rate != "NA") %>% filter(standardised_rate != "Inf") 

pHresprates <- pHresprates %>% mutate_at(c("Treatment", "Tank", "Colour", "Treatment", "HS", "pCO2"), as.factor)

pHresprates <- rename(pHresprates, Rate = standardised_rate) 

#Obtain summary data to plot
pHresprates_summary <- pHresprates %>%
  group_by(pCO2, Colour, HS) %>% 
  summarise(meanrate=mean(Rate), semrate=sd(Rate)/(sqrt(n())))

```

### Plot the pH data

Boxplots of the data
```{r}
pHresprates$pCO2 <- factor(pHresprates$pCO2, levels = c("CTRL", "250", "500", "750", "1000"))#Set the order of the facets 
pHresprates %>% filter(HS == "HS") %>% 
  ggplot(aes(x=pCO2, y= Rate, fill=Colour))+geom_boxplot()

pHresprates %>% filter(HS != "HS") %>% 
  ggplot(aes(x=pCO2, y= Rate, fill=Colour))+geom_boxplot()
```

Response curve of oxygen consumption

```{r}
pHresprates_summary$pCO2 <- factor(pHresprates_summary$pCO2, levels = c("CTRL", "250", "500", "750", "1000"))
pHcurve_nohs <- pHresprates_summary %>%
  #filter(HS != "HS") %>%
  ggplot(aes(x = pCO2, y = meanrate, group = Colour, colour = Colour)) +
  geom_line(size = 1) +
  geom_errorbar(aes(ymin = meanrate - semrate, ymax = meanrate + semrate), width = 0.2) +
  theme_bw(base_size = 20) +
  xlab("pCO2") +
  ylab("Mean oxygen consumption (µmol h-1 g-1)") +
  scale_color_manual(values = c("#CD950C", "#00688B", "#8B0A50"),   # Custom colors for each group
                     breaks = c("Blue", "Green", "Red"),   # Names of your groups
                     labels = c("Diploid", "Mated Triploids", "Induced Triploids"))+   # Custom labels for each group
  labs(color = "Ploidy")+  # Change the legend title to "Ploidy"
  facet_wrap(~HS, nrow = 2) +
  theme(strip.text = element_blank())
pHcurve_nohs #THIS WAS EXPORTED AT A SIZE OF 10x12 Inches



```

### Statistical analysis

Perform a statistical analysis on the data. Doing a linear mixed model with tank as a random effect as we don't care about tank. 

Examine the distribution of the data

```{r}
hist((pHresprates$Rate))
hist(sqrt(pHresprates$Rate+0.001))

```

A sqrt transformation made the data much more normaly distributed. Thus sqrt transformed data will be used for the statistical analyses

##### Non heat shocked individuals

 Model selction process to determine if we need random effects

```{r}
#First create a model with no ransom effects
pHresp_gls <- pHresprates %>% filter(HS == "NOHS") %>%
  gls(sqrt(Rate+0.001)~Colour*pCO2, method="REML", data=.)
#then create a model with random effects
pHresp_lme <- pHresprates %>% filter(HS == "NOHS") %>%
  lme(sqrt(Rate+0.001)~Colour*pCO2, random = ~1 | Tank, data=.)

anova(pHresp_gls, pHresp_lme)
```

No significant difference existed between the model that included the ransom effects of tank and the one with no random effects. Thus, going forward i will be using the model with no random effects. 

```{r}
#Because there are zeros in the data I am going to need to add a very small number to make the data transformable
pHresprates$ratenozero <- pHresprates$Rate+0.01
pHresp_lme <- pHresprates %>% filter(HS == "NOHS") %>%
  lm(sqrt(Rate+0.001)~Colour*pCO2, data=.)
summary(pHresp_lme)
anova(pHresp_lme)
residuals <- resid(pHresp_lme)
qqnorm(residuals)
qqline(residuals) #RESIDUALS ARE SHIT
```

#### Heat Shocked individuals

Compare a model that includes random effects with one that doesn't


```{r}
#First create a model with no ransom effects
pHresp_gls_HS <- pHresprates %>% filter(HS == "HS") %>%
  gls(sqrt(Rate+0.001)~Colour*pCO2, method="REML", data=.)
#then create a model with random effects
pHresp_lme_HS <- pHresprates %>% filter(HS == "HS") %>%
  lme(sqrt(Rate+0.001)~Colour*pCO2, random = ~1 | Tank, data=.)

anova(pHresp_gls_HS, pHresp_lme_HS)
```

Adding a random effect does not improve the model significantly so I am going to use a glm

```{r}
pHresp_lme_HS <- pHresprates %>% filter(HS == "HS") %>% 
  lme(sqrt(Rate+0.001)~Colour*pCO2, random = ~1 | Tank, data=.)
summary(pHresp_lme_HS)
anova(pHresp_lme_HS)
residuals <- resid(pHresp_lme_HS)
qqnorm(residuals)
qqline(residuals)
```


# DO 

## Growth
```{r}
sizedat_DO <- read.csv(here("Data", "DO", "DO_SIZE_DATA.csv"))

sizedat_DO <- sizedat_DO %>% 
  mutate(across(c("Treatment","Tank", "Ploidy", "Time"), as.factor)) %>% 
  mutate(across(c("Mass", "Shell.Height"), as.numeric))

```

Plot the sizes at the start and end of the experiment

```{r}
sizedat_DO %>% #filter(Treatment != 100) %>% 
  ggplot(aes(x=Ploidy, y= Mass, fill = Time))+geom_boxplot()+facet_wrap(~Treatment)+
  theme_bw(base_size = 20)+scale_fill_manual(values = c("red", "blue"), breaks = unique(sizedat_temp$Time), labels = c("Start", "End"))+
  scale_x_discrete(labels = c("Diploids", "Induced Triploids", "Mated Triploids"))+
  ylab("Mass (g)")
```

### Statistical analysis of growth data
Linear mixed model using tank as a random factor. Even though tank is unlikley to be of importance. 

Check the distribution of the data
```{r}
hist(sizedat_DO$Mass)
hist(log(sizedat_DO$Mass))

hist(sizedat_DO$Shell.Height) #Better to keep  this untransformed, 
#hist(log(sizedat_DO$Shell.Height))
```


```{r}
massgrowthlme_DO <- sizedat_DO %>% 
  lme(log(Mass)~Ploidy*Time*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(massgrowthlme_DO)

emmeans_massgrowthlme_DO <- emmeans(massgrowthlme_DO, ~ Ploidy*Treatment)
masscontrasts <- pairs(emmeans_massgrowthlme_DO)
masscontrasts
masscontrasts_df <- as.data.frame(masscontrasts)
write.csv(filter(masscontrasts_df, p.value<0.05), "DO_masscontrasts.csv")
```

There was a signifcant ploidy*treatment interaction. However within each ploidy and treatment there were no differences in the size of individuals between the start and the end of the experiment. No impact of DO on growth.

Repeat the same thing for shell height
```{r}
heightgrowthlme_DO <- sizedat_DO %>% filter(Shell.Height!= "NA") %>% 
  lme((Shell.Height)~Ploidy*Time*Treatment, random = ~1 | Tank, data=.) #This model includes a random effect of tank. 
anova(heightgrowthlme_DO)

emmeans_heightgrowthlme_DO <- emmeans(heightgrowthlme_DO, ~ Ploidy*Treatment)
heightcontrasts <- pairs(emmeans_heightgrowthlme_DO)
heightcontrasts
heightcontrasts_df <- as.data.frame(masscontrasts)
write.csv(filter(heightcontrasts_df, p.value<0.05), "DO_heightcontrasts.csv")
```

Although there was a significant ploidy*treatment interaction there were no signifcant differences in shell height between the start and the end of the experiment in any of the groups observed. 

## Mortality

Read in the mortality data, and format it so that I can run survival analyses. 
```{r}
DO_survivors <- read.csv(here("Data", "DO", "DO__survivors.csv"))
DO_survivors$Tank <- as.factor(DO_survivors$Tank)
DO_tank_assignments <- read.csv(here("Data", "DO", "DO_tank_assignments.csv"))
#Uncount each of the rows in the first survivor colum
individ_mortdat_DO <- DO_survivors %>%
  select(1:3) %>%
  uncount(weights = Surv_1)
individ_mortdat_DO$ID <- rep(1:30, length.out = nrow(individ_mortdat_DO))#Add an ID column so each individual has a unique ID

individ_mortdat_DO$status_Surv_0 <- 0

#Create a df to store all survival event data for analyes
survival_eventdat_DO <- individ_mortdat_DO

#create a for loop that gives all survivors a status across all
for (i in 3:34) {
  # Extract the current column name
  current_column_name <- colnames(DO_survivors)[i]
  
  # Remove "Survivors_" from the current column name
  stripped_column_name <- current_column_name
  
  # Create a new column name based on the stripped current column name
  new_column_name <- paste0("status_", stripped_column_name)
  
  # Uncount the specified column
  survivors_column <- DO_survivors[c(1:2, i)] %>%
    mutate(weights = as.numeric(get(current_column_name))) %>%
    uncount(weights)
  
  # Add an ID column from 1 to 15
  survivors_column <- survivors_column %>%
    group_by(across(c(1, 2))) %>%
    mutate(ID = row_number()) %>%
    ungroup()
  
  # Add a status column to indicate that these individuals are alive
  survivors_column[[new_column_name]] <- 0
  
  # Join the data frames
  survival_eventdat_DO <- left_join(survival_eventdat_DO, survivors_column, by = c("Tank", "Colour", "ID"))
}
 
#Select the columns that status at the begining
survival_eventdat_DO <- survival_eventdat_DO %>% select(-starts_with("Surv"))
#Now need to pivot longer for survival plots
survival_eventdat_DO <- survival_eventdat_DO %>% pivot_longer(cols= -c(1:3), names_to = "Time", values_to = "Status")
#Remove the status from the time column
survival_eventdat_DO <- survival_eventdat_DO %>% mutate(Time = gsub("status_Surv_", "", Time))
#Add 1 where there is a NA
survival_eventdat_DO$Status[is.na(survival_eventdat_DO$Status)] <- 1
#Only keep the first instance of 1 (An individual can only die once - Cue James Bond music).
survival_eventdat_DO <- survival_eventdat_DO %>%
  group_by(Tank, Colour, ID) %>%
  filter(row_number() <= which.max(Status == 1) | sum(Status == 1) == 0) %>% ungroup()
#Make sure that the sum of mortality events actually matches the number of mortalities. In the DOerature experiment this was 20
survival_eventdat_DO$event <- survival_eventdat_DO$Status
survival_eventdat_DO$Time <- as.numeric(survival_eventdat_DO$Time)
sum(survival_eventdat_DO$Status)
#Merge the file with the list of treatment tanks
survival_eventdat_DO <- merge(survival_eventdat_DO, DO_tank_assignments, by = "Tank")


```

Plot the mortality between tanks faceted by DO level

```{r}
survival_eventdat_DO$DO <- factor(survival_eventdat_DO$DO, levels = c("20", "40", "60", "80", "100"))#Set#Order the facets
pooled_site_survplot_DO_pooled <- survival_eventdat_DO %>% filter(Time <= 28) %>% 
  #filter(DO != 100) %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
            facet.by = "DO",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            legend.labs = c("Induced Triploid","Diploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.7, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 20)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("#00688B", "#CD950C", "#8B0A50"))+
  scale_fill_manual(values = c("#00688B", "#CD950C", "#8B0A50"))
pooled_site_survplot_DO_pooled

#Do it long to see the comparisons
longpooled_site_survplot_DO_pooled <- pooled_site_survplot_DO_pooled <- survival_eventdat_DO %>% filter(Time <= 28) %>% 
  #filter(DO != 100) %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
            facet.by = "DO",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            legend.labs = c("Induced Triploid","Diploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.7, 1),
            legend.strata = FALSE,
            ncol = 1)+
  theme_bw(base_size = 20)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("#00688B", "#CD950C", "#8B0A50"))+
  scale_fill_manual(values = c("#00688B", "#CD950C", "#8B0A50"))



grid.arrange(longpooled_site_survplot_temp_pooled,longpooled_site_survplot_DO_pooled, longpooled_site_survplot_pH_pooled, ncol = 3)
```

Facet by Tank

```{r}
pooled_site_survplot_DO_pooled_tank <- survival_eventdat_DO %>% 
 ggsurvplot_facet(survfit(Surv(Time, event, type = "right") ~ Colour , data = .),
            facet.by = "Tank",
            data = .,
            risk.table = FALSE, pval = FALSE, conf.int = TRUE, 
            #legend.labs = c("Diploid", "Induced Triploid", "Mated Triploid"),
            xlab = "Time (days)",
             ylim = c(0.6, 1),
            legend.strata = FALSE, 
            legend.title = "Ploidy")+
  theme_bw(base_size = 15)+
  labs(legend = "ploidy")+
  scale_color_manual(values = c("blue", "green", "red"))+
  scale_fill_manual(values = c("blue", "green", "red"))
pooled_site_survplot_DO_pooled_tank
```

Facet by ploidy


## Respiration

Read in the respiration data

```{r}
DO_respdat <- read.csv(here("Data", "DO", "DO_resprates.csv")) %>% 
  select(Tank, Ploidy, Treatment, Oyster.tissue.dry.mass, masscorrectedrate, rate) %>% #just select the relevant columns
  rename(drymass = Oyster.tissue.dry.mass) %>% #rename drymass column
  filter(masscorrectedrate > -100)
#make the rates column positive
DO_respdat$masscorrectedrate <- DO_respdat$masscorrectedrate*-1
#for some reason there are 3C individuals in here. These are really 3C's so I'll replace them with 3C
DO_respdat <- DO_respdat %>% mutate(Ploidy = case_when(
    Ploidy == "2C" ~ "3C",
    TRUE ~ Ploidy  # Keep other values unchanged
  ))
#Remove the single value that does not have a ploidy
DO_respdat <- DO_respdat %>% filter(Ploidy != "")

```

Calculate an oxygen consumption rate per gram per gram. 

```{r}
DO_respdat$O2gramgram <- DO_respdat$masscorrectedrate/DO_respdat$drymass
```


### Overview of the data

Organise the data

```{r}
#Add a HS or no HS cvolumn
DO_respdat <- DO_respdat %>% 
  mutate(HS = case_when(
    str_detect(Treatment, "HS") ~ "HS",
    TRUE ~ "NOHS"
  )) %>% 
  mutate(O2 = str_replace(Treatment, "HS", ""))
#Replace the percentages with a concentration
DO_respdat <- DO_respdat %>% mutate(O2 = case_when(
    O2 == 100 ~ "9.57",
    O2 == 80 ~ "7.66",
    O2 == 60 ~ "5.74",
    O2 == 40 ~ "3.83",
    O2 == 20 ~ "1.91",
    TRUE ~ O2  # Keep other values unchanged
  ))


```

Create a summary table of the data

```{r}
DO_resp_summarytable <- DO_respdat %>% filter(masscorrectedrate != "NA") %>% 
  group_by(Ploidy, O2, HS) %>% 
  summarise(n=n(), mean_rate=mean(masscorrectedrate), SEMrate=sd(masscorrectedrate)/sqrt(n()))
```

Create physiological performance curves. Start for the non heat shocked individuals. For these analyses and plots I was unable to achieve 100% oxygen saturation so I am removing the 100% treatment from analyses.Physiological curves for heat shocked individuals. 

```{r}
#Switch the order of the O2 concentrations to match the pH from least stresful to most stresful
DO_resp_summarytable$O2 <- factor(DO_resp_summarytable$O2, levels = c("9.57", "7.66", "5.74", "3.83", "1.91"))
#Plot data
PhyscurvDO <- DO_resp_summarytable %>% 
  filter(O2 != "9.57") %>% 
  ggplot(aes(x=O2, y= mean_rate, group = Ploidy, colour = Ploidy))+geom_line(size = 1)+#base graph
  geom_errorbar(aes(ymin=mean_rate-SEMrate, ymax=mean_rate+SEMrate), width = 0.2, size = 0.5)+ #error bars
  ylim(0,5.3)+
  scale_color_manual(values = c("#CD950C", "#00688B", "#8B0A50"),   # Custom colors for each group
                     breaks = c("2M", "3M", "3C"),   # Names of your groups
                     labels = c("Diploid", "Mated Triploids", "Induced Triploids"))+   # Custom labels for each group
  labs(color = "Ploidy")+  # Change the legend title to "Ploidy"
  theme_bw(base_size = 20)+ylab("Mean oxygen consumption rate (µmol g-1 h-1 ± SEM)")+
  xlab("Oxygen concentration (mg l-1)")+
  facet_wrap(~HS, nrow=2)+theme(strip.text = element_blank())
PhyscurvDO
#Create the same graph with standardised again by gram. This is not really that informative
# DO_resp_summarytable %>% filter(Treatment != "80HS" & Treatment != "60HS" & Treatment !="20HS") %>% 
#   filter(Treatment != "100") %>% 
#   ggplot(aes(x=Treatment, y= mean_rate_gramgram, group = Ploidy, colour = Ploidy))+geom_line()+
#   geom_errorbar(aes(ymin=mean_rate_gramgram-SEMgramgram, ymax=mean_rate_gramgram+SEMgramgram))

```



```{r}
PhyscurvDOHS <- DO_resp_summarytable %>% filter(Treatment == "80HS" | Treatment == "60HS" | Treatment =="20HS") %>% 
  filter(Treatment != "100") %>% 
  ggplot(aes(x=Treatment, y= mean_rate, group = Ploidy, colour = Ploidy))+geom_line(size = 1)+
  geom_errorbar(aes(ymin=mean_rate-SEMrate, ymax=mean_rate+SEMrate), width = 0.2, size = 0.5)+
  ylim(0,5.3)+
  theme_classic(base_size = 15)+ylab("Mean oxygen consumption rate (µmol g-1 h-1 ± SEM)")+
  xlab("Oxygen concentration")+scale_color_brewer(palette = "Dark2")
grid.arrange(PhyscurvDO, PhyscurvDOHS)
```


### statistical analyses

Examine the distribution of the data
```{r}
hist(DO_respdat$masscorrectedrate)

```

The data was left skewed so a square root
```{r}
hist(sqrt((DO_respdat$masscorrectedrate+0.001))
```

The sqrt data has a much more normal distribution so this will be used in the further analyses. 

I am going to do a model selection procedure to determine if there is evidence that a random effect is needed

#### Non heat shocked
```{r}
#First model has no random effects
DO_resp_gls <- DO_respdat %>% filter(HS == "NOHS") %>%
  gls(sqrt((masscorrectedrate+0.001))~Ploidy*O2, method="REML", data=.)
#then create a model with random effects
DOresp_lme <- DO_respdat %>% filter(HS == "NOHS") %>%
  lme(sqrt((masscorrectedrate+0.001))~Ploidy*O2, random = ~1 | Tank, data=.)
anova(DO_resp_gls, DOresp_lme) #No significant differences between the models. AIC is within two for both. Going to use plain GLM
```

There is no evidence to support the use of tank as a randeom effect so I will jsut perform a GLM

```{r}
DOrespglm <- DO_respdat %>% filter(HS == "NOHS") %>%
  lm(sqrt((masscorrectedrate+0.001))~Ploidy*O2, data=.)
anova(DOrespglm)
#There is a significant effect of ploidy in this experiment. 
# Perform post-hoc pairwise tests
emmeans_results <- emmeans(DOrespglm, pairwise ~ Ploidy, adjust = "tukey")

# Display the results
summary(emmeans_results)
```

Diploids consume signifcantly more oxygen than mated triploids, but there was no difference between any of the other groups in the non heat shocked group.


####  heat shocked
```{r}
#First model has no random effects
DO_resp_gls_HS <- DO_respdat %>% filter(HS == "HS") %>%
  gls(sqrt((masscorrectedrate+0.001))~Ploidy*O2, method="REML", data=.)
#then create a model with random effects
DOresp_lme_HS <- DO_respdat %>% filter(HS == "HS") %>%
  lme(sqrt((masscorrectedrate+0.001))~Ploidy*O2, random = ~1 | Tank, data=.)
anova(DO_resp_gls_HS, DOresp_lme_HS) #No significant differences between the models. AIC is within two for both. Going to use plain GLM
```

There is no evedince to support the use of tank as a randeom effect so I will just perform a GLM

```{r}
DOrespglm_HS <- DO_respdat %>% filter(HS == "HS") %>%
  lm(sqrt((masscorrectedrate+0.001))~Ploidy*O2, data=.)
anova(DOrespglm_HS)
#There is a significant effect of ploidy in this experiment. 
# Perform post-hoc pairwise tests
emmeans_results <- emmeans(DOrespglm, pairwise ~ Ploidy, adjust = "tukey")

# Display the results
summary(emmeans_results)
```

No significant impacts on the way that heat shocked individuals respond to stress. 